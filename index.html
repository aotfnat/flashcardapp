<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Study Cards</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111" />
<style>
:root {
  --bg: #ffffff;
  --text: #111;
  --card: #f4f4f4;
}

body.dark {
  --bg: #111;
  --text: #eee;
  --card: #1c1c1c;
}

body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:20px;
  max-width:900px;
  margin:auto;
}

.card {
  background:var(--card);
  padding:40px;
  border-radius:14px;
  margin:20px 0;
  min-height:180px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  font-size:20px;
}

img {
  max-width:100%;
  margin-top:10px;
  border-radius:10px;
}

button {
  padding:10px 16px;
  margin:5px;
  border-radius:8px;
  border:none;
  background:#333;
  color:white;
}

select, input {
  padding:8px;
  margin:5px;
}

.ipad body {
  max-width:1200px;
}
</style>
</head>
<body>

<h2>Study Cards</h2>

<select id="deckSelect"></select>
<button onclick="toggleDark()">Dark Mode</button>
<button onclick="toggleLayout()">iPhone/iPad</button>

<div class="card" onclick="flipCard()" id="card">Tap to Begin</div>

<div>
  <button onclick="markCard(true)">Correct</button>
  <button onclick="markCard(false)">Incorrect</button>
</div>

<p>Retention: <span id="retention">0%</span></p>

<hr>

<h3>Add Card</h3>
<input id="question" placeholder="Question"><br>
<input id="answer" placeholder="Answer"><br>
<input type="file" id="imageUpload"><br>
<button onclick="addCard()">Add</button>

<hr>

<h3>Decks</h3>
<input id="newDeck" placeholder="New Deck Name">
<button onclick="addDeck()">Add Deck</button>

<hr>

<h3>Import / Export</h3>
<input type="file" id="csvFile">
<button onclick="importCSV()">Import CSV</button>
<button onclick="exportCSV()">Export CSV</button>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

let data = JSON.parse(localStorage.getItem("studyData")) || {
  decks: {},
  stats: { correct:0, total:0 }
};

let currentDeck = null;
let currentCard = null;
let showingAnswer = false;

function save() {
  localStorage.setItem("studyData", JSON.stringify(data));
}

function addDeck() {
  const name = document.getElementById("newDeck").value.trim();
  if(!name) return;
  data.decks[name] = [];
  currentDeck = name;
  save();
  renderDecks();
}

function renderDecks() {
  const select = document.getElementById("deckSelect");
  select.innerHTML = "";
  Object.keys(data.decks).forEach(deck=>{
    const opt = document.createElement("option");
    opt.value = deck;
    opt.textContent = deck;
    select.appendChild(opt);
  });
  if(!currentDeck) currentDeck = Object.keys(data.decks)[0];
  select.value = currentDeck;
  select.onchange = e=>{
    currentDeck = e.target.value;
  };
}
renderDecks();

function addCard() {
  const q = question.value.trim();
  const a = answer.value.trim();
  if(!q || !a || !currentDeck) return;

  const file = imageUpload.files[0];
  if(file) {
    const reader = new FileReader();
    reader.onload = function() {
      saveCard(q,a,reader.result);
    };
    reader.readAsDataURL(file);
  } else {
    saveCard(q,a,null);
  }
}

function saveCard(q,a,img) {
  data.decks[currentDeck].push({
    q,a,img,
    interval:1,
    next:Date.now()
  });
  save();
  question.value="";
  answer.value="";
  imageUpload.value="";
}

function getDueCards() {
  return data.decks[currentDeck].filter(c=>c.next<=Date.now());
}

function flipCard() {
  if(!currentDeck) return;
  const due = getDueCards();
  if(due.length===0){
    card.innerHTML="No cards due.";
    return;
  }
  if(!currentCard){
    currentCard = due[Math.floor(Math.random()*due.length)];
    showingAnswer=false;
  }
  card.innerHTML = showingAnswer ?
    currentCard.a + (currentCard.img?`<img src="${currentCard.img}">`:"") :
    currentCard.q;
}

function markCard(correct) {
  if(!currentCard) return;
  data.stats.total++;
  if(correct){
    data.stats.correct++;
    currentCard.interval *=2;
  } else {
    currentCard.interval =1;
  }
  currentCard.next = Date.now() + currentCard.interval*86400000;
  currentCard=null;
  save();
  updateRetention();
  card.innerHTML="Next card...";
}

function updateRetention(){
  if(data.stats.total===0) return;
  retention.textContent =
    Math.round((data.stats.correct/data.stats.total)*100)+"%";
}
updateRetention();

function toggleDark(){
  document.body.classList.toggle("dark");
}

function toggleLayout(){
  document.body.classList.toggle("ipad");
}

function importCSV(){
  const file = csvFile.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const rows = e.target.result.split("\n");
    rows.forEach(r=>{
      const [deck,q,a] = r.split(",");
      if(!data.decks[deck]) data.decks[deck]=[];
      data.decks[deck].push({
        q,a,img:null,interval:1,next:Date.now()
      });
    });
    save();
    renderDecks();
  };
  reader.readAsText(file);
}

function exportCSV(){
  let csv="";
  Object.keys(data.decks).forEach(deck=>{
    data.decks[deck].forEach(c=>{
      csv+=`${deck},${c.q},${c.a}\n`;
    });
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download="flashcards.csv";
  a.click();
}
</script>

</body>
</html>