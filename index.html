<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Study Cards</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111" />

<style>
:root {
  --bg: #ffffff;
  --text: #111;
  --card: #f4f4f4;
}

body.dark {
  --bg: #111;
  --text: #eee;
  --card: #1c1c1c;
}

body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:20px;
  max-width:900px;
  margin:auto;
}

.card {
  background:var(--card);
  padding:40px;
  border-radius:14px;
  margin:20px 0;
  min-height:180px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  font-size:20px;
}

img {
  max-width:100%;
  margin-top:12px;
  border-radius:10px;
}

/* Primary study buttons */
.study-btn {
  width:100%;
  padding:22px 0;
  margin:8px 0;
  border-radius:10px;
  border:none;
  font-size:18px;
  font-weight:600;
  color:white;
}

.show-answer {
  background:#333;
}

.correct {
  background:#2e7d32;
}

.incorrect {
  background:#c62828;
}

.hidden {
  display:none;
}

select, input {
  padding:8px;
  margin:5px;
  width:100%;
  max-width:400px;
}
</style>
</head>
<body>

<h2>Study Cards</h2>

<select id="deckSelect"></select>
<button onclick="toggleDark()">Dark Mode</button>

<div class="card" id="card">Tap “Show Question” to begin</div>

<button class="study-btn show-answer" id="showBtn" onclick="showAnswer()">Show Question</button>

<button class="study-btn correct hidden" id="correctBtn" onclick="gradeCard(true)">Correct</button>
<button class="study-btn incorrect hidden" id="incorrectBtn" onclick="gradeCard(false)">Incorrect</button>

<p>Retention: <span id="retention">0%</span></p>

<hr>

<h3>Decks</h3>
<input id="newDeck" placeholder="New Deck Name">
<button onclick="addDeck()">Add Deck</button>

<hr>

<h3>Import CSV</h3>
<input type="file" id="csvFile">
<button onclick="importCSV()">Import</button>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

let data = JSON.parse(localStorage.getItem("studyData")) || {
  decks: {},
  stats: { correct:0, total:0 }
};

let currentDeck = null;
let currentCard = null;

function save() {
  localStorage.setItem("studyData", JSON.stringify(data));
}

function addDeck() {
  const name = document.getElementById("newDeck").value.trim();
  if(!name) return;
  data.decks[name] = [];
  currentDeck = name;
  save();
  renderDecks();
}

function renderDecks() {
  const select = document.getElementById("deckSelect");
  select.innerHTML = "";
  Object.keys(data.decks).forEach(deck=>{
    const opt = document.createElement("option");
    opt.value = deck;
    opt.textContent = deck;
    select.appendChild(opt);
  });
  if(!currentDeck) currentDeck = Object.keys(data.decks)[0];
  select.value = currentDeck;

  select.onchange = e=>{
    currentDeck = e.target.value;
    // RESET STATE when deck changes
    currentCard = null;
    card.innerHTML = 'Tap “Show Question” to begin';
    showBtn.classList.remove("hidden");
    correctBtn.classList.add("hidden");
    incorrectBtn.classList.add("hidden");
  };
}

function getDueCards() {
  if(!data.decks[currentDeck]) return [];
  return data.decks[currentDeck].filter(c=>c.next<=Date.now());
}

function loadQuestion() {
  const due = getDueCards();
  if(due.length === 0) {
    card.innerHTML = "No cards due.";
    showBtn.classList.add("hidden");
    return;
  }

  currentCard = due[Math.floor(Math.random()*due.length)];
  card.innerHTML = currentCard.q;

  showBtn.textContent = "Show Answer";
  correctBtn.classList.add("hidden");
  incorrectBtn.classList.add("hidden");
}

function showAnswer() {
  if(!currentCard) {
    loadQuestion();
    return;
  }

  card.innerHTML = currentCard.a +
    (currentCard.img ? `<img src="${currentCard.img}">` : "");

  showBtn.classList.add("hidden");
  correctBtn.classList.remove("hidden");
  incorrectBtn.classList.remove("hidden");
}

function gradeCard(correct) {
  data.stats.total++;
  if(correct){
    data.stats.correct++;
    currentCard.interval *= 2;
  } else {
    currentCard.interval = 1;
  }

  currentCard.next = Date.now() + currentCard.interval * 86400000;

  save();
  updateRetention();

  currentCard = null;
  correctBtn.classList.add("hidden");
  incorrectBtn.classList.add("hidden");
  showBtn.classList.remove("hidden");
  showBtn.textContent = "Show Question";
  card.innerHTML = "Tap “Show Question” for next card";
}

function updateRetention(){
  if(data.stats.total === 0) return;
  retention.textContent =
    Math.round((data.stats.correct/data.stats.total)*100)+"%";
}
updateRetention();

/* CSV FORMAT:
   Column 1 = Question
   Column 2 = Answer
   File name (without .csv) = Deck name
*/
function importCSV(){
  const file = csvFile.files[0];
  if(!file) return;

  const deckName = file.name.replace(".csv","");

  if(!data.decks[deckName]) data.decks[deckName]=[];

  const reader = new FileReader();
  reader.onload = function(e){
    const rows = e.target.result.split("\n");
    rows.forEach(r=>{
      if(!r.trim()) return;
      const [q,a] = r.split(",");
      if(q && a){
        data.decks[deckName].push({
          q:q.trim(),
          a:a.trim(),
          img:null,
          interval:1,
          next:Date.now()
        });
      }
    });
    currentDeck = deckName;
    save();
    renderDecks();
    alert("Imported into deck: " + deckName);
  };
  reader.readAsText(file);
}

function toggleDark(){
  document.body.classList.toggle("dark");
}
</script>

</body>
</html>